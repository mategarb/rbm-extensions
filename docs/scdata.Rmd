---
title: "scdata"
output: html_document
date: "2025-01-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r block1, echo=T, results = 'hide', message=FALSE, warning=FALSE}
library(R.ROSETTA)
library(Seurat)
library(biomaRt)
library(AnnotationDbi)
library(org.Mm.eg.db)
library(fitdistrplus)
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(ggplotify)

# single cell data (Lee et al., 2022) https://www.ebi.ac.uk/gxa/sc/experiments/E-MTAB-10371/results?plotType=UMAP&plotOption=20&k=6
path = '/Users/matga374/Downloads/E-MTAB-10371-normalised-files/E-MTAB-10371.aggregated_filtered_normalised_counts.mtx'
expression_matrix <- ReadMtx(
  mtx = path,
  features = paste0(path, "_rows"),
  cells = paste0(path, "_cols"))

```

genes = expression_matrix@Dimnames[1]
meta = read.table("/Users/matga374/Downloads/ExpDesign-E-MTAB-10371.tsv", sep = '\t', header = TRUE)
symbols = mapIds(
  org.Mm.eg.db,
  keys = as.matrix(unlist(genes)) %>% as.vector,
  column = 'SYMBOL',
  keytype = 'ENSEMBL')
expression_matrix@Dimnames[[1]] <- paste0(unname(symbols),"-", names(symbols))

injr <- CreateSeuratObject(counts = expression_matrix, project = "mm", min.cells = 3, min.features = 200)

# filtration

injr <- subset(injr, cells = which(meta$Sample.Characteristic.post.analysis.well.quality. == "fail"), invert = TRUE)

injr <- NormalizeData(injr, normalization.method = "LogNormalize", scale.factor = 10000)
injr <- FindVariableFeatures(injr, selection.method = "vst", nfeatures = 2000)

# Identify the 10 most highly variable genes
top10 <- head(VariableFeatures(injr), 10)

# plot variable features with and without labels
plot1 <- VariableFeaturePlot(injr)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot1 + plot2


all.genes <- rownames(injr)
injr <- ScaleData(injr, features = all.genes)

injr <- RunPCA(injr, features = VariableFeatures(object = injr))
DimPlot(injr, reduction = "pca") + NoLegend()

injr <- FindNeighbors(injr, dims = 1:10)
injr <- FindClusters(injr, resolution = 0.5)

injr <- RunUMAP(injr, dims = 1:10)
injr <- RunTSNE(injr, dims = 1:10)
# note that you can set `label = TRUE` or use the LabelClusters function to help label
# individual clusters

cols = meta$Factor.Value.injury.[-which(meta$Sample.Characteristic.post.analysis.well.quality. == "fail")]

#levels(cols) = c("black","red")

p1 <- DimPlot(injr, reduction = "umap") + labs(color = "cluster")+
  theme(text = element_text(size=18))+ theme(legend.position="top")

p2 <- DimPlot(injr, reduction = "umap", cells.highlight = meta$Assay[cols != "none"], cols.highlight = "red", cols = "gray", order = TRUE)+ 
  scale_color_manual(labels = c("Homeostasis", "Injury"), values = c("black", "#f587a9")) +
  theme(text = element_text(size=18))+ theme(legend.position="top")

library(dplyr)
counts.df <- injr@assays$RNA@layers$scale.data %>% as.matrix %>% t %>% as.data.frame
rownames(counts.df) <- injr@assays$RNA@cells@.Data %>% row.names
colnames(counts.df) <- injr@assays$RNA@features@.Data %>% row.names

clusterassignemnts <- data.frame(injr@active.ident)
counts.df <- cbind(counts.df, clusterassignemnts)

#counts.df = counts.df[-which(counts.df$injr.active.ident == 4),]
#counts.df = counts.df[-which(counts.df$injr.active.ident == 5),]
#counts.df = counts.df[-which(counts.df$injr.active.ident == 1),]

outcome = paste0("cluster_",counts.df$injr.active.ident %>% as.character)
#outcome[outcome == "cluster_0"] <- "cluster0&1"
#outcome[outcome == "cluster_1"] <- "cluster0&1"

#outcome[outcome == "cluster_2"] <- "cluster2&3"
#outcome[outcome == "cluster_3"] <- "cluster2&3"

counts.df$injr.active.ident <- outcome
colnames(counts.df)[ncol(counts.df)] <- "outcome"
counts.df <- counts.df[,c(head(VariableFeatures(injr), 100), "outcome")]

gnss <- lapply(strsplit(colnames(counts.df),"-"),function(x) x[1]) %>% unlist
gnse <- lapply(strsplit(colnames(counts.df),"-"),function(x) x[2]) %>% unlist

gnss[which(unlist(gnss)=="NA")] <- gnse[which(unlist(gnss)=="NA")]
colnames(counts.df) <- gnss

saveRDS(counts.df,"//Users//matga374//Desktop//sc_data_lee_et_al.rds")


out_jon_sc <- rosetta(counts.df, discreteParam = 3, underSample = T, underSampleNum = 20,
                      JohnsonParam = list(Modulo=TRUE, BRT=FALSE, BRTprec=0.9, Precompute=FALSE, Approximate=TRUE, Fraction=0.9))
out_jon_sc$quality

out_jon_sc$main
saveRDS(out_jon_sc,"//Users//matga374//Desktop//rrosetta_model_sc_disc3_us20_johnson09.rds")

out_jon_sc_signif <- out_jon_sc$main[which(out_jon_sc$main$pValue<0.05),]
out_jon_sc_signif_double <- out_jon_sc_signif[grep(",",out_jon_sc_signif$features),]




require(VisuNet)

vis_out <- visunet(out_jon_sc_signif_double, type = "RDF")
rls = out_jon_sc$main[which(out_jon_sc$main$pValue<0.05),]
rls = rls[which(rls$accuracyRHS>0.55),]
rls = rls$features[which(rls$coverageRHS>0.2)]


vals <- unname(table(unlist(strsplit(rls[grep(",",rls)], ","))))
freqs <- table(vals)

descdist(vals %>% as.numeric, discrete = FALSE,obs.col = "#FF5D1B")
p5 <- recordPlot()

